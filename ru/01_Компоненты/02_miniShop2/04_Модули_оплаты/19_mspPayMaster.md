## mspPayMaster
Метод приема платежей через PayMaster для [miniShop2](https://modstore.pro/packages/ecommerce/minishop2) с виджетом способов оплаты.
[![](https://file.modx.pro/files/6/f/8/6f839744ca6a22bbc87013f788a0b83c.jpg)](https://file.modx.pro/files/6/f/8/6f839744ca6a22bbc87013f788a0b83c.jpg)

Для того, чтобы принимать платежи с помощью PayMaster, нужно сначала [заключить договор с этой системой](http://info.paymaster.ru)

## Инструкция
Для корректной работы компонента, необходимо выставить следующие настройки
в личном кабинете системы PayMaster и в настройках MODX:
1. В личном кабинете PayMaster настройках сайта должен быть выставлен правильный URL вашего сайта.
[![](https://file.modx.pro/files/6/e/9/6e9b44c1edcaa900ea9cbef4805617ees.jpg)](https://file.modx.pro/files/6/e/9/6e9b44c1edcaa900ea9cbef4805617ee.jpg)

2. Состояние сайта должно быть переведено в "Рабочий режим". 
(Иногда в рабочий режим можно перевести только через тех. поддержку PayMaster!)
3. Тип подписи должен быть выбран SHA256.
4. Секретный ключ должен быть задан вручную. (пример ключа можно посмотреть в настройках компонента в админке MODX.
5. ОБЯЗАТЕЛЬНО должны быть выставлены правильно "Обратные вызовы":
5. 1 Payment notification "POST запрос".
5. 2 Success redirect "POST запрос".
5. 3 Failure redirect "POST запрос".
5. 4 Invoice confirmation "Не принимать действий".
5. 5 Отмечен галочкой пункт "Разрешена замена URL".
6. В "Платежные системы" должны быть в "Рабочий режим" добавлены методы оплаты 
(методы оплаты для платежных систем подключаются через обращение в тех поддержку PayMaster!)
[![](https://file.modx.pro/files/8/6/8/868462189cb127b606e932f007e9d653s.jpg)](https://file.modx.pro/files/8/6/8/868462189cb127b606e932f007e9d653.jpg)

7. В системных настройках minishop2 в разделе платежи нужно выставить:
(некоторые пункты могут не поместиться на одной странице, и переносятся во второй раздел "Платежи", который объединяется с первым разделом "Платежи", только если все элементы вывести на одну страницу (не понятно что за глюк такой в этом разделе). 
[![](https://file.modx.pro/files/f/4/1/f4122831cda1d0c2f0684a0364bd2a8f.jpg)](https://file.modx.pro/files/f/4/1/f4122831cda1d0c2f0684a0364bd2a8f.jpg)
[![](https://file.modx.pro/files/b/e/7/be7b4e2775166bf8289625a30820afb8s.jpg)](https://file.modx.pro/files/b/e/7/be7b4e2775166bf8289625a30820afb8.jpg)

7. 1 Индефикатор магазина, который дается в панеле управления PayMaster в настройках сайта.
7. 2 Секретный ключ, который мы задавали в ручную в пункте 4.
7. 3 Страница отказа от оплаты и страница успешной оплаты, нужно вписать ID ресурсов, созданных вручную с нужным вам текстом и оформлением.
7. 4 ID Платежных систем задан по умолчанию в формате название:ключ. Если какие-то способы оплаты не работают, нужно уточнить ID этих платежных систем в тех. поддержке PayMaster.
8. Нужно включить способ оплаты Paymaster в настройках minishop2 и выбрать этот способ оплаты в нужных вариантах доставки!
9. Нужно обязательно, чтоб у вас на странице оформления заказа была подключена библиотека jquery.min, если её нет, то она идет в комплекте, для этого нужно в `<head></head>` добавить тег `<script src="/assets/components/msppaymaster/js/jquery-1.11.1.min.js"></script>`
Если все эти пункты выполнены, то компонент будет работать правильно, если вдруг работал и перестал работать, скорее всего в PayMaster отключили вам методы оплаты в рабочем режиме, либо сменился ID платежных систем, то нужно обращаться в тех. поддержку PayMaster.
В системных настройках можно удалить в "ID Платежных систем" платежные системы, которые не будут использоваться у вас, их виджеты не будут отображаться в корзине, а так же добавить новые.
По умолчанию платежные системы (виджеты): (visamc:93,svyaznoi:65,psb:64,euroset:62,wm:31,brs:24,vtb24:22,alfabank:8,sberbank:126,pr:132,qiwi:46,yandex:30,mts:102) без скобок.

## КАК ДОБАВИТЬ ЕЩЕ ОДИН ВИДЖЕТ?
Нужно узнать ID платежной системы для виджета в тех.поддержке PayMaster, к примеру нам нужен тинькофф и у него будет id 66, тогда в системных настройках minishop2 нуно добавить tinkoff:66
Теперь создаем изображение 125x70 px называем его так же, как и в системных настройках tinkoff, и делаем у него расширение ОБЯЗАТЕЛЬНО .jpg (с другим расширением работать не будет) и закидываем его в папку "/assets/components/msppaymaster/img/pay/" и виджет будет автоматически добавлен.

## КАК ОТКЛЮЧИТЬ ВСЕ ВИДЖЕТЫ?
Для этого можно либо удалить в системных настройках minishop2 все значения "ID Платежных систем", любо в настройках способы оплаты для способа Paymaster в описании убрать чанк `[[$tpl.mspPMWidget]]`

## ПРИНЦИП РАБОТЫ:
Если на странице оформления заказа нажать на любой виджет, то будет выбран и способ оплаты Paymaster, тогда после нажатия на кнопку оформить заказ вас переадресует на страницу с оплатной через выбранный способ (например банковской картой).
Если выбрать просто способ оплаты Paymaster, а виджет при этом не выбран, то после оформления заказа вас переадресует на страницу системы Paymaster, где можно будет выбрать нужный способ.

## КАК ИЗМЕНИТЬ ОФОРМЛЕНИЕ ВИДЖЕТА?
Можно править (ВНИМАНИЕ! Изменение этих файлов может нарушить работу виджета):
tpl.mspPMWidget - чанк для виджета и вызова сниппета, вызов которого прописывается в настройках способа оплаты для Paymaster в описании.
tpl.mspPMWidget.row - чанк оформления отдельной системы оплаты.
"/assets/components/msppaymaster/css/paymaster.css" собственно сам стиль оформления виджетов.
